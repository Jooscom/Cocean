<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC	"-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<mapper namespace="kr.co.cocean.approval.dao.ApprovalDAO">	
	
	<select id="list" resultType="form">
		SELECT * FROM draftForm
	</select>
	
	<select id="formSearch" parameterType="list" resultType="form">
		SELECT * FROM draftForm WHERE title IN
			<foreach collection="list" item="item" open ="(" separator = "," close=")">
			 #{item}
			</foreach>
	</select>
	
	<select id="draftInfo" resultType="form">
		SELECT DISTINCT name,r.rankName, departmentName,workDate,h.hqName FROM employee e LEFT OUTER JOIN department d ON e.departmentID=d.departmentID RIGHT OUTER JOIN headquarters h ON d.hqID=h.hqID
 		LEFT OUTER JOIN work w ON e.employeeID=w.employeeID LEFT OUTER JOIN rank r ON e.rankID=r.rankID WHERE e.employeeID=#{employeeID} ORDER BY workDate DESC LIMIT 1
	</select>
	
	<insert 
		id="write" 
		useGeneratedKeys="true"
		keyColumn="idx"
		keyProperty="idx">
    	INSERT INTO draft (employeeID,publicStatus,tempSave,documentNo) VALUES (#{employeeID},#{publicStatus},#{tempSave},#{documentNo})
	</insert>
	
	<insert id="writeWorkDraft">
    	INSERT INTO workDraft (title,content,idx) VALUES (#{title},#{content},#{idx})
	</insert>
	
	<insert id="writeFile">
    	INSERT INTO file (category,idx,path,serverFileName,oriFileName) VALUES ('결재',#{idx},'draft',#{newFileName},#{oriFileName})
	</insert>
	
	<select id="employeeInfo" resultType="form">
		SELECT DISTINCT name,r.rankName, departmentName,h.hqName,e.employeeID FROM employee e LEFT OUTER JOIN department d ON e.departmentID=d.departmentID RIGHT OUTER JOIN headquarters h ON d.hqID=h.hqID 
 		LEFT OUTER JOIN rank r ON e.rankID=r.rankID WHERE e.employeeID=#{employeeID};
	</select>
	
	<select id="waitingList" resultType="form">
		SELECT d.draftDate,e.employeeID,a.idx,w.title,e.name,a.approvalStatus FROM approval a LEFT OUTER JOIN draft d ON a.idx=d.idx RIGHT OUTER JOIN employee e ON d.employeeID=e.employeeID 
		LEFT OUTER JOIN workDraft w ON a.idx=w.idx where a.employeeID=#{employeeID} AND a.approvalStatus='대기';
	</select>
	
	<select id="draftDetail" resultType="form">
		SELECT DISTINCT name,r.rankName, departmentName,h.hqName,df.draftDate,w.title,w.content FROM employee e LEFT OUTER JOIN department d ON e.departmentID=d.departmentID RIGHT OUTER JOIN headquarters h ON d.hqID=h.hqID 
 		LEFT OUTER JOIN rank r ON e.rankID=r.rankID LEFT OUTER JOIN draft df ON e.employeeID=df.employeeID LEFT OUTER JOIN workDraft w ON df.idx=w.idx WHERE e.employeeID=#{employeeID} AND df.idx=#{idx};
	</select>
	
	<insert id="saveApprovalLine">
    	INSERT INTO draft (employeeID,documentNo) VALUES (#{employeeID},#{employeeID})
	</insert>
	
	<insert id="approvalWrite" parameterType="map">
	    INSERT INTO approval (idx, employeeID, category, approvalOrder)
	    VALUES
	    <foreach collection="lastLineInfoList" item="line" separator=",">
	        (#{idx}, #{line.approvalEmp}, #{line.category},
	        <choose>
	            <when test="line.order != null">#{line.order}</when>
	            <otherwise>'0'</otherwise>
	        </choose>)
	    </foreach>
	</insert>
</mapper>